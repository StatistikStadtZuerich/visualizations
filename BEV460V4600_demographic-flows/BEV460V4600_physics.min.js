function sszvis_physics(e,t,n){"use strict";function r(){}function o(e){q=e,W=new L(new N(0,0),!0),I=g(W,ae/2+ne,ie/2),I.setYear(q),I.setType(r.TYPE_BESTAND);var t=30,n=.5*ie-t,o=.5*ie+t;J=b(W,q,ue,r.TYPE_ZUZUG,o),Q=v(W,q,ue,r.TYPE_WEGZUG,o),$=b(W,q,ue,r.TYPE_GEBURT,n),ee=v(W,q,ue,r.TYPE_TOD,n),re=c(J,[I],Q,$,ee),P(re);var a=Q;te=c(J,[I],a),oe=u(re);var i=re.filter(function(e){return e.year==I.year&&(e.type==r.TYPE_TOD||e.type==r.TYPE_WEGZUG)});i.forEach(function(e){var t=20;t=e.type==r.TYPE_WEGZUG?t:-t;var n=e.getX(),o=e.getY()+t;e.setPos(n,o)});var f=j[q].bestNettoBubbles,l=z(W,f,I.x,I.y,50);s(l,I.year,r.TYPE_BESTAND),ce=ce.concat(l);var h=j[q].zuzBubbles,p=j[q].gebBubbles,d=80,B=z(W,h,I.x+d,I.y+d,30),E=z(W,p,I.x+d,I.y-d,30);s(B,I.year,r.TYPE_ZUZUG),s(E,I.year,r.TYPE_GEBURT),ce=ce.concat(B),ce=ce.concat(E);var T=y(W,j,J,"zuzBubbles");ce=ce.concat(T);var Y=y(W,j,Q,"wegBubbles");ce=ce.concat(Y);var x=y(W,j,$,"gebBubbles");ce=ce.concat(x);var D=y(W,j,ee,"todBubbles");ce=ce.concat(D)}function a(e){var t=sszvis.fn.set(e,function(e){return U(e)}),n=t.map(function(t){var n=e.filter(function(e){return U(e)===t}),r=t,o=sszvis.parse.year(""+t),a=n.filter(function(e){return"Bevölkerung"==i(e)}),u=n.filter(function(e){return"Basisbevölkerung"==i(e)}),c=a,s=n.filter(function(e){return"Zuzüge"==i(e)}),f=n.filter(function(e){return"Wegzüge"==i(e)}),y=n.filter(function(e){return"Geburten"==i(e)}),l=n.filter(function(e){return"Todesfälle"==i(e)});return{year:r,date:o,bestand:a[0].value,bestandNetto:u[0].value,value:c[0].value,zuzug:s[0].value,wegzug:f[0].value,geburt:y[0].value,tod:l[0].value}});return n}function i(e){return e.category}function u(e){var t=[];return e.forEach(function(e){var n=e.getKey();t[n]=e}),t}function c(){var e=[],t=Array.prototype.slice.call(arguments);return t.forEach(function(t){e=e.concat(t)}),e}function s(e,t,n){e.forEach(function(e){e.setYear(t),e.setType(n)})}function f(e){var t=[];return e.forEach(function(e){t[e.year]=e}),t}function y(e,t,n,r){var o=[];return n.forEach(function(n){var a=t[n.year],i=a[r],u=z(e,i,n.x,n.y,20);l(u,n.year,n.type),o=o.concat(u)}),o}function l(e,t,n){e.forEach(function(e){e.setYear(t),e.setType(n)})}function b(e,t,n,r,o){for(var a=[],i=t,u=I.x,c=85,s=140,f=0;n>f;f++){var y=u+s+f*c,l=o,b=i+f+1,v=g(e,y,l);v.setYear(b),v.setType(r),a.push(v)}return a}function v(e,t,n,r,o){for(var a=[],i=t,u=I.x,c=85,s=60,f=100,y=0;n>y;y++){var l=0;l=0===y?u-s:1===y?u-s-f:u-s-f-(y-1)*c;var b=o,v=i-y,h=g(e,l,b);h.setYear(v),h.setType(r),a.push(h)}return a}function g(e,t,n){var r={x:t,y:n,radius:.1,gravity:50,body:null,type:"",year:-1};r.getKey=function(){return h(this.year,this.type)},r.setYear=function(e){this.year=e},r.setType=function(e){this.type=e},r.setPos=function(e,t){this.x=e,this.y=t;var n=new N(Z(e),Z(t));r.body.SetPosition(n)},r.setY=function(e){this.y=e},r.getX=function(){return this.x},r.getY=function(){return this.y};var o=new F;o.density=10,o.friction=10,o.restitution=0;var a=new R;return a.type=O.b2_staticBody,o.shape=new K(Z(r.radius)),o.isSensor=!1,a.position.x=Z(r.x),a.position.y=Z(r.y),r.body=e.CreateBody(a),r.body.CreateFixture(o),r}function h(e,t){return""+e+"-"+t}function p(e){var t=e.map(function(e){return e.zuzBubbles=Math.ceil(e.zuzug/k),e.wegBubbles=Math.ceil(e.wegzug/k),e.bestBubbles=Math.ceil(e.bestand/k),e.bestNettoBubbles=Math.ceil(e.bestandNetto/k),e.gebBubbles=Math.ceil(e.geburt/k),e.todBubbles=Math.ceil(e.tod/k),e});return t}function d(e){var t=ce.filter(function(e){return e.year==I.year&&e.type==r.TYPE_WEGZUG}),n=ce.filter(function(e){return e.year==I.year&&e.type==r.TYPE_TOD});D(I,t),D(I,n);var o=ce.filter(function(e){return e.year==I.year&&e.type==I.type});x(e,I,J,Q,$,ee),P(re),D(I,o);var a=re.map(U),i=Y(ce,a);ce=E(ce,i);var c=Q[Q.length-1],s=ee[ee.length-1],f=j[c.year],y=f?f.wegBubbles:0,l=f?f.todBubbles:0,b=z(W,y,c.x-100,c.y,30),v=z(W,l,s.x-100,s.y,30);D(c,b),D(s,v),ce=ce.concat(b),ce=ce.concat(v);var f=j[I.year],g=f.zuzBubbles,h=f.gebBubbles;o.sort(function(e,t){var n=e.getPos(),r=t.getPos();return r.x-n.x});var p=o.slice(0,g),d=o.slice(g,g+h);p.forEach(function(e){e.setYear(I.year),e.setType(r.TYPE_ZUZUG)}),d.forEach(function(e){e.setYear(I.year),e.setType(r.TYPE_GEBURT)}),oe=u(re)}function B(e){var t=ce.filter(function(e){return e.year==I.year&&e.type==r.TYPE_ZUZUG}),n=ce.filter(function(e){return e.year==I.year&&e.type==r.TYPE_GEBURT});D(I,t),D(I,n);var o=ce.filter(function(e){return e.year==I.year&&e.type==I.type});x(e,I,J,Q,$,ee),P(re),D(I,o);var a=re.map(U),i=Y(ce,a);ce=E(ce,i);var c=J[J.length-1],s=j[c.year],f=s?s.zuzBubbles:0,y=z(W,f,c.x+100,c.y,30);D(c,y),ce=ce.concat(y);var l=$[$.length-1],s=j[l.year],f=s?s.gebBubbles:0,y=z(W,f,l.x+100,l.y,30);D(l,y),ce=ce.concat(y);var b=Q[0],v=ee[0],s=j[b.year],g=s.wegBubbles,h=s.todBubbles;o.sort(function(e,t){var n=e.getPos(),r=t.getPos();return n.x-r.x});var p=o.slice(0,g),d=o.slice(g,g+h);D(b,p),D(v,d),oe=u(re)}function E(e,t){var n=e.filter(function(e){return t.indexOf(e)<0});return T(t),n}function T(e){e.forEach(function(e){e.kill()})}function Y(e,t){var n=e.filter(function(e){return t.indexOf(e.year)<0});return n}function x(e,t,n,r,o,a){t.setYear(e),n.forEach(function(t,n){t.setYear(e+n+1)}),o.forEach(function(t,n){t.setYear(e+n+1)}),r.forEach(function(t,n){t.setYear(e-n)}),a.forEach(function(t,n){t.setYear(e-n)})}function P(e){e.forEach(function(e){var t=e.year,n=j[t];e.value=n?n[e.type]:-1})}function D(e,t){t.forEach(function(t){t.setYear(e.year),t.setType(e.type)})}function G(e){var t=e.getVel(),n=new N(0,0);n.Add(t),n.Multiply(-se),e.body.ApplyForce(n,e.body.GetWorldCenter())}function _(e,t){m(e.body,t.body,e.gravity)}function m(e,t,n){var r=t.GetWorldCenter(),o=e.GetWorldCenter();if(pe.Set(0,0),pe.Add(r),pe.Subtract(o),!(pe.Length()<.01)){var a=5/pe.Length()*pe.Length()*pe.Length();pe.Normalize(),pe.NegativeSelf(),pe.Multiply(a),t.ApplyForce(pe,t.GetWorldCenter())}}function z(e,t,n,r,o){for(var a=[],i=V,u=o?o:40,c=0;t>c;c++){var s=n+C(-u,u),f=r+C(-2*u,2*u),y=w(e,s,f,i,O.b2_dynamicBody);a.push(y)}return a}function w(e,t,n,r,o){var a=new F;a.density=10,a.friction=1,a.restitution=0,a.shape=new K(Z(r));var i=new R;i.type=o,i.position.x=Z(t),i.position.y=Z(n),i.linearDamping=0,i.angularDamping=.01;var u=e.CreateBody(i);u.CreateFixture(a);var c={radius:r,year:-1,type:"",body:u,world:e};return c.setYear=function(e){this.year=e},c.setType=function(e){this.type=e},c.setPos=function(e,t){var n=new N(Z(e),Z(t));this.body.SetPosition(n)},c.getPos=function(){var e=this.body.GetPosition();return new N(S(e.x),S(e.y))},c.getVel=function(){return this.body.GetLinearVelocity()},c.getKey=function(){return h(this.year,this.type)},c.kill=function(){this.world.DestroyBody(this.body)},c}function U(e){return e.year}function C(e,t){var n;if(n=Math.random(),0===arguments.length)return n;if(1===arguments.length)return n*e;if(e>t){var r=e;e=t,t=r}return n*(t-e)+e}function Z(e){return e/H}function S(e){return e*H}var A,M,W,N=Box2D.Common.Math.b2Vec2,R=(Box2D.Collision.b2AABB,Box2D.Dynamics.b2BodyDef),O=Box2D.Dynamics.b2Body,F=Box2D.Dynamics.b2FixtureDef,L=(Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2World),K=(Box2D.Collision.Shapes.b2PolygonShape,Box2D.Collision.Shapes.b2CircleShape),k=(Box2D.Dynamics.b2DebugDraw,Box2D.Dynamics.Controllers.b2BuoyancyController,Box2D.Dynamics.b2ContactListener,2e3),V=3,X=[],j=[],q=2001,H=30,I=null,J=[],Q=[],$=[],ee=[],te=[],ne=10,re=[],oe=[],ae=e,ie=t,ue=3,ce=[],se=1,fe=!1,ye=!1,le=[],be=7,ve=0,ge=n,he=60,pe=new N(0,0);return r.TYPE_BESTAND="bestand",r.TYPE_ZUZUG="zuzug",r.TYPE_WEGZUG="wegzug",r.TYPE_GEBURT="geburt",r.TYPE_TOD="tod",r.getCurrentYear=function(){return q},r.getParticles=function(){return ce},r.getAllAnchors=function(){return re},r.getLabelAnchors=function(){return te},r.getPeoplePerBubble=function(){return k},r.getBubbleRadius=function(){return V},r.getMidOffset=function(){return ne},r.getDataByYear=function(){return j},r.addParticles=function(e,t,n){var o=z(W,n,I.x,I.y,5);s(o,t,r.TYPE_BESTAND),ce=ce.concat(o)},r.removeParticles=function(e,t,n){var r=ce.filter(function(e){return"bestand"==e.type&&e.year==t}),o=r.slice(0,n);console.assert(o.length===n,"toBeKilled not right size expected  "+n+" got:  "+o.length),ce=E(ce,o)},r.update=function(){if(!fe)return void console.log("proc.update not ready, returning");if(ye)return void console.log("ERROR,returning");if(ve--,0>=ve&&(ve=be,le.length>0)){var e=le.shift();r.setYear(e),ge()}W.Step(1/he,20,20),W.ClearForces(),ce.forEach(function(e){var t=oe[e.getKey()];t||(e.year==I.year&&e.type==r.TYPE_ZUZUG?t=I:e.year==I.year&&e.type==r.TYPE_GEBURT?t=I:ye=!0),_(t,e),G(e)})},r.setYear=function(e){if(fe=!0,e==q)return void(fe=!0);if(e>q)for(;e>q;)q++,B(q);else if(q>e)for(;q>e;)q--,d(q);else console.log("something is wrong in setYear");fe=!0},r.setYear2=function(e){if(fe=!0,0===le.length)return void le.push(e);for(var t=le[le.length-1],n=e-t,r=Math.abs(n),o=n>0?1:-1,a=0;r>a;a++)le.push(t+(a+1)*o);fe=!0},r.init=function(e,t){var n=a(e);X=n,j=f(X),X=p(X);var r=X.map(U);A=d3.min(r),M=d3.max(r),o(t),fe=!0},r}
